{% extends "base.html" %}

{% block contenido %}
<div class="p-6 sm:p-10">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Clientes</h1>

  <!-- Filtro -->
  <div class="mb-6">
    <label for="busquedaCuenta" class="block text-sm font-medium text-gray-700 mb-1">Buscar por número de
      cuenta:</label>
    <input type="text" id="busquedaCuenta" placeholder="Escribe aquí..."
      class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:border-blue-400">
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow-md p-4">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600">Nombre</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600">Cédula</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600">Correo</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600">Cuenta</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600">Documentos</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-600 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaClientes" class="bg-white divide-y divide-gray-100">
          {% for cliente in clientes %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 text-sm text-gray-800">{{ cliente.name }}</td>
            <td class="px-6 py-4 text-sm text-gray-800">{{ cliente.cedula }}</td>
            <td class="px-6 py-4 text-sm text-gray-800">{{ cliente.correo }}</td>
            <td class="px-6 py-4 text-sm text-gray-800">{{ cliente.numero_cuenta }}</td>
            <td class="px-6 py-4 text-center">
              <a href="{{ url_for('ver_documento', cliente_id=cliente.id) }}"
                class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-md text-sm px-4 py-1.5 transition duration-200">
                Ver documentos
              </a>
            </td>
            <td class="px-6 py-4 text-center">
              <div class="flex flex-wrap justify-center gap-2">
                <!-- Botón pagar deuda -->
                <button onclick="abrirModalPago({{ cliente.id }})"
                  class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded-md">Pagar Deuda</button>

                <!-- Botón agregar deuda -->
                <button onclick="abrirModalDeuda({{ cliente.id }})"
                  class="bg-yellow-600 hover:bg-yellow-700 text-white text-sm px-3 py-1.5 rounded-md">Agregar
                  Deuda</button>

                <!-- Editar cliente -->
                <!-- Reemplaza dentro de la tabla el botón de editar -->
                <!-- Editar cliente -->
                <button type="button"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1.5 rounded-md"
                  data-bs-toggle="modal" data-bs-target="#modalEditarCliente{{ cliente.id }}">
                  Editar
                </button>

                <!-- Modal Editar Cliente -->
                <div class="modal fade" id="modalEditarCliente{{ cliente.id }}" tabindex="-1"
                  aria-labelledby="modalEditarClienteLabel{{ cliente.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <form method="POST" action="{{ url_for('editar_cliente', cliente_id=cliente.id) }}"
                      enctype="multipart/form-data">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" id="modalEditarClienteLabel{{ cliente.id }}">Editar Cliente</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label for="name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="name" value="{{ cliente.name }}" required>
                          </div>
                          <div class="mb-3">
                            <label for="cedula" class="form-label">Cédula</label>
                            <input type="text" class="form-control" name="cedula" value="{{ cliente.cedula }}" required>
                          </div>
                          <div class="mb-3">
                            <label for="archivo" class="form-label">Pdf con cédula y papel de votación</label>
                            <input type="file" class="form-control" name="archivo" accept="application/pdf">
                          </div>
                          <div class="mb-3">
                            <label for="numero_cuenta" class="form-label">Número de Cuenta</label>
                            <input type="text" class="form-control" name="numero_cuenta"
                              value="{{ cliente.numero_cuenta }}" readonly required>
                          </div>
                          <div class="mb-3">
                            <label for="correo" class="form-label">Correo</label>
                            <input type="email" class="form-control" name="correo" value="{{ cliente.correo }}"
                              required>
                          </div>
                          <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" name="telefono" value="{{ cliente.telefono }}">
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                          <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>


                <!-- Eliminar cliente -->
                <a href="{{ url_for('eliminar_cliente', cliente_id=cliente.id) }}"
                  class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1.5 rounded-md"
                  onclick="return confirm('¿Estás seguro de eliminar este cliente?')">Eliminar</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Agregar Deuda -->
<div id="modalDeuda" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold mb-4">Agregar Deuda</h2>
    <form method="POST" action="{{ url_for('agregar_deuda') }}">
      <input type="hidden" name="cliente_id" id="inputClienteDeuda">
      <div class="mb-3">
        <label class="block text-sm font-medium">Monto Total</label>
        <input type="number" name="deuda_total" class="w-full border px-3 py-2 rounded-md" required>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Fecha</label>
        <input type="date" name="fecha" class="w-full border px-3 py-2 rounded-md" required>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Descripción</label>
        <textarea name="descripcion" class="w-full border px-3 py-2 rounded-md"></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Interés</label>
        <input type="number" step="0.01" name="interes" class="w-full border px-3 py-2 rounded-md">
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Interés por Mora</label>
        <input type="number" step="0.01" name="interes_mora" class="w-full border px-3 py-2 rounded-md">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModal('modalDeuda')"
          class="bg-gray-300 px-4 py-2 rounded-md">Cancelar</button>
        <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded-md">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para Pagar Deuda -->
<div id="modalPago" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold mb-4">Pagar Deuda</h2>
    <form method="POST" action="{{ url_for('pagar_deuda') }}">
      <input type="hidden" name="cliente_id" id="inputClientePago">
      <div class="mb-3">
        <label class="block text-sm font-medium">Monto del Abono</label>
        <input type="number" step="0.01" name="abono" class="w-full border px-3 py-2 rounded-md" required>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium">Fecha de Pago</label>
        <input type="datetime-local" name="fecha_pago" class="w-full border px-3 py-2 rounded-md">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModal('modalPago')"
          class="bg-gray-300 px-4 py-2 rounded-md">Cancelar</button>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModalDeuda(clienteId) {
    document.getElementById("inputClienteDeuda").value = clienteId;
    document.getElementById("modalDeuda").classList.remove("hidden");
    document.getElementById("modalDeuda").classList.add("flex");
  }

  function abrirModalPago(clienteId) {
    document.getElementById("inputClientePago").value = clienteId;
    document.getElementById("modalPago").classList.remove("hidden");
    document.getElementById("modalPago").classList.add("flex");
  }

  function cerrarModal(id) {
    const modal = document.getElementById(id);
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
</script>


<!-- JavaScript para búsqueda en tiempo real -->
<script>
  document.getElementById("busquedaCuenta").addEventListener("input", function () {
    const query = this.value;

    fetch(`/buscar_clientes?cuenta=${query}`)
      .then(response => response.json())
      .then(data => {
        const tabla = document.getElementById("tablaClientes");
        tabla.innerHTML = "";

        if (data.length === 0) {
          tabla.innerHTML = "<tr><td colspan='6' class='text-center py-4'>No se encontraron resultados</td></tr>";
        }

        data.forEach(cliente => {
          const fila = `
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 text-sm text-gray-800">${cliente.name}</td>
            <td class="px-6 py-4 text-sm text-gray-800">${cliente.cedula}</td>
            <td class="px-6 py-4 text-sm text-gray-800">${cliente.correo}</td>
            <td class="px-6 py-4 text-sm text-gray-800">${cliente.numero_cuenta}</td>
            <td class="px-6 py-4 text-sm">
              <a href="/ver_documento/${cliente.id}"
                class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-md text-sm px-4 py-1.5 transition duration-200">
                Ver documentos
              </a>
            </td>
            <td class="px-6 py-4 text-center">
              <div class="flex flex-wrap justify-center gap-2">
                <!-- Botón pagar deuda -->
                <button onclick="abrirModalPago(${cliente.id})"
                  class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1.5 rounded-md">Pagar Deuda</button>

                <!-- Botón agregar deuda -->
                <button onclick="abrirModalDeuda(${cliente.id})"
                  class="bg-yellow-600 hover:bg-yellow-700 text-white text-sm px-3 py-1.5 rounded-md">Agregar
                  Deuda</button>

                <!-- Editar cliente -->
                <!-- Reemplaza dentro de la tabla el botón de editar -->
                <!-- Editar cliente -->
                <button type="button"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1.5 rounded-md"
                  data-bs-toggle="modal" data-bs-target="#modalEditarCliente${cliente.id }">
                  Editar
                </button>
                <a href="/eliminar_cliente/${cliente.id}"
                  class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1.5 rounded-md"
                  onclick="return confirm('¿Estás seguro de eliminar este cliente?')">Eliminar</a>
              </div>
            </td>
          </tr>
        `;
          tabla.innerHTML += fila;
        });
      });
  });
</script>
{% endblock %}